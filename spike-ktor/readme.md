# Spike Ktor

Spike Ktor is a modular routing library for [Ktor](https://ktor.io/) that leverages the Spike dependency injection system to decouple route definitions from the main application configuration.

## Features

- **Modular Routing**: Define routes in separate, self-contained classes.
- **Type-Safe Entry Points**: Use Spike's entry point system to aggregate routes.
- **Regex Support**: Full support for both string and regex-based routing.
- **Clean Integration**: Simple Ktor plugin installation.

## Installation

Add the `spike-ktor` dependency to your project:

```kotlin
dependencies {
    implementation TODO()
}
```

## Getting Started

### 1. Define a Route Builder

Create a class that implements `RegularRouteBuilder`. Use the `@spike.Include` annotation to tell the Spike compiler to include this route in the routing set.

```kotlin
import io.ktor.server.application.*
import io.ktor.server.response.*
import io.ktor.server.routing.*
import spike.ktor.RegularRouteBuilder

@spike.Include(
    bindAs = spike.ktor.RouteBuilder::class,
    bindTo = spike.BindTarget.Set
)
class HomeRoute : RegularRouteBuilder {
    override val path = "/"

    override fun Route.build() {
        get {
            call.respondText("Welcome to Spike Ktor!")
        }
    }
}
```

### 2. Create an Entry Point

Define an interface that extends `BaseRouteEntryPoint`. This interface will be implemented by the Spike compiler.

```kotlin
import spike.EntryPoint
import spike.ktor.BaseRouteEntryPoint

@EntryPoint
interface RouteEntryPoint : BaseRouteEntryPoint {
    companion object
}
```

### 3. Install the Plugin

In your Ktor application module, install the `Spike` plugin and provide an instance of your entry point.

```kotlin
import io.ktor.server.application.*
import spike.ktor.Spike

fun Application.module() {
    install(Spike) {
        // RouteEntryPoint() is the implementation generated by Spike
        entryPoint(RouteEntryPoint())
    }
}
```

## Advanced Usage

### Regex Routing

For routes that require complex matching, implement `RegexRouteBuilder`:

```kotlin
class ProductRoute : RegexRouteBuilder {
    override val path = Regex("/product/(?<id>\\d+)")

    override fun Route.build() {
        get {
            val id = call.parameters["id"]
            call.respondText("Product ID: $id")
        }
    }
}
```

### Testing

Testing Spike Ktor applications is straightforward using the standard `testApplication` utility:

```kotlin
class ServerTest {
    @Test
    fun `test home route`() = testApplication {
        application {
            install(Spike) {
                entryPoint(RouteEntryPoint())
            }
        }
        val response = client.get("/")
        assertEquals(HttpStatusCode.OK, response.status)
    }
}
```
